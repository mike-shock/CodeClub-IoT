


 
08. Сетевое взаимодействие по MQTT


Практические задания.

Цель: научиться разрабатывать программы, обменивающиеся данными через брокер MQTT.
Задача:  Разработать программу чтения данных по протоколу MQTT.

№ 08.0
    1. Установите брокер и клиенты Mosquitto на свою Raspberry Pi, выполнив в терминальном окне команды:
       sudo apt-get update
       sudo apt-get install mosquitto mosquitto-clientsrb
    2. Откройте 1-е терминальное окно. Запустите проверочный командный скрипт-подписчик, который ждёт сообщения в теме sensor/temperature:
       ~/CodeClub-IoT/samples/mqtt_sub.rb
    3. Откройте 2-е терминальное окно. Запустите проверочный командный скрипт-издатель, который отправит сообщение в тему sensor/temperature:
       ~/CodeClub-IoT/samples/mqtt_pub.rb
    4. В 1-м окне должно быть выведено значение сообщения: 25.5.
    5. Закройте оба терминальных окна.

№ 08.1 
    1. Запустите редактор Geany из раздела «Программирование» в главном меню.
    2. Откройте в редакторе Geany пример программы, публикующей сообщения на брокере MQTT: ~/CodeClub-IoT/samples/mqtt_pub.rb.
    3. Запустите программу на выполнение из раздела меню «Сборка», пункт «Execute» (выполнить) и проверьте её работу. Закройте терминальное окно.
    4. Создайте в редакторе Geany новую программу, которая будет отправлять на брокер Mosquitto в заданную тему сообщения с показаниями температуры со встроенного термодатчика Raspberry Pi:
       #!/usr/bin/ruby
       require 'mqtt'           # подключить библиотеку для работы с mqtt
       require 'thermal_sensor' # библиотека аботы с термодатчиком
       BROKER = '10.36.254.16'                 # адрес или имя брокера
       sensor = RaspberryPi::ThermalSensor.new # создать объект «датчик»
       while true do                           # в бесконечном цикле
         sensor.read_data                      # считать показание датчика
         t = sensor.celsius.to_s               # преобразовать его в строку
         MQTT::Client.connect(BROKER) do |client|  # подключиться к брокеру
           client.publish('sensor/temperature', t) # опубликовать
         end
         sleep 1
       end
    5. Сохраните её под именем ~/CodeClub-IoT/samples/mqtt_thermo.rb
    6. Запустите программу на выполнение из раздела меню «Сборка», пункт «Execute» (выполнить) и убедитесь, что она работает. Не закрывайте окно.
    7. Откройте в редакторе Geany пример программы, читающей сообщения на брокере MQTT: ~/CodeClub-IoT/samples/mqtt_sub.rb.
    8. Запустите её, чтобы проверить, что она читает сообщения с брокера.
    9. Измените её так, чтобы она читала сообщения и  выводила их в бесконечном цикле.



Дополнительное задание.

1. Пусть одна из Raspberry Pi будет брокером MQTT. Узнайте IP-адрес её беспроводного интерфейса (wlan0) командой:
    ip address

2. Обменяйтесь сообщениями с товарищами через этот брокер, публикуя сообщения в определённой теме, а затем читая сообщения из этой темы.
3. Проверьте, что можно читать сообщения из темы с разных узлов одновременно.
